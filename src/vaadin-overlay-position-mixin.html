<!--
@license
Copyright (c) 2019 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<script>
  window.Vaadin = window.Vaadin || {};
  window.Vaadin.Overlay = window.Vaadin.Overlay || {};

  /**
   * @polymerMixin
   */
  Vaadin.Overlay.PositionMixin = superClass => class PositionMixin extends superClass {

    static get properties() {
      return {
        positionTarget: {
          type: Object,
          value: null
        },

        horizontalAlign: {
          type: String,
          value: 'start',
          reflectToAttribute: true
        },
        verticalAlign: {
          type: String,
          value: 'top',
          reflectToAttribute: true
        },

        horizontalOverlap: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        verticalOverlap: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        horizontalOffset: {
          type: Number,
          value: 0,
          reflectToAttribute: true
        },
        verticalOffset: {
          type: Number,
          value: 0,
          reflectToAttribute: true
        }
      };
    }
    static get observers() {
      return [`_positionSettingsChanged(positionTarget, horizontalAlign, verticalAlign,
        horizontalOverlap, verticalOverlap, horizontalOffset, verticalOffset)`];
    }

    connectedCallback() {
      super.connectedCallback();
      const boundUpdatePosition = this.updatePosition.bind(this);

      this.addEventListener('opened-changed', e => {
        const func = e.detail.value ? 'addEventListener' : 'removeEventListener';
        window[func]('scroll', boundUpdatePosition);
        window[func]('resize', boundUpdatePosition);
      });
    }

    _positionSettingsChanged() {
      setTimeout(() => this.updatePosition());
    }

    updatePosition() {
      if (!this.positionTarget) {
        return;
      }
      this.setAttribute('_horizontal-align', this.getAttribute('horizontal-align'));
      this.setAttribute('_vertical-align', this.getAttribute('vertical-align'));

      const targetRect = this.positionTarget.getBoundingClientRect();

      const ltr = getComputedStyle(this).direction === 'ltr';
      let leftAlign = (ltr && this.horizontalAlign === 'start')
        || (!ltr && this.horizontalAlign === 'end');

      let horAlignProp = leftAlign ? 'left' : 'right';
      let x = this.__getX(horAlignProp, targetRect);

      // Switch sides if not fitting and other side has more space (currently works only for left-aligned)
      if (targetRect.left + targetRect.width / 2 > this._viewportWidth / 2 && this.$.overlay.clientWidth >= this.clientWidth) {
        this._toggleHorizontalAlignAttribute();
        leftAlign = !leftAlign;
        horAlignProp = leftAlign ? 'left' : 'right';
        x = this.__getX(horAlignProp, targetRect);
      }

      let y = this.verticalOffset || 0;
      if (this.verticalAlign === 'top') {
        this.style.removeProperty('bottom');
        y += targetRect.top;
      } else {
        this.style.removeProperty('top');
        const viewportHeight = Math.min(window.innerHeight, document.documentElement.clientHeight);
        y += viewportHeight - targetRect.bottom
      }
      if (!this.verticalOverlap) {
        y += targetRect.height;
      }
      this.style[this.verticalAlign] = y + 'px';
    }

    __getX(horAlignProp, targetRect) {
      let x = this.horizontalOffset || 0;
      if (horAlignProp === 'left') {
        this.style.removeProperty('right');
        x += targetRect.left;
      } else {
        this.style.removeProperty('left');
        x += this._viewportWidth - targetRect.right;
      }
      if (!this.horizontalOverlap) {
        x += targetRect.width;
      }
      this.style[horAlignProp] = x + 'px';
      return x;
    }

    get _viewportWidth() {
      return Math.min(window.innerWidth, document.documentElement.clientWidth);
    }

    _toggleHorizontalAlignAttribute() {
      if (this.getAttribute('_horizontal-align') === 'start') {
        this.setAttribute('_horizontal-align', 'end');
      } else {
        this.setAttribute('_horizontal-align', 'start');
      }
    }
  };
</script>
