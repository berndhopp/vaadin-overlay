<!--
@license
Copyright (c) 2019 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<script>
  window.Vaadin = window.Vaadin || {};
  window.Vaadin.Overlay = window.Vaadin.Overlay || {};

  /**
   * @polymerMixin
   */
  Vaadin.Overlay.PositionMixin = superClass => class PositionMixin extends superClass {

    static get properties() {
      return {
        positionTarget: {
          type: Object,
          value: null
        },

        horizontalAlign: {
          type: String,
          value: 'start',
          reflectToAttribute: true
        },
        verticalAlign: {
          type: String,
          value: 'top',
          reflectToAttribute: true
        },

        horizontalOverlap: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        verticalOverlap: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        horizontalOffset: {
          type: Number,
          value: 0,
          reflectToAttribute: true
        },
        verticalOffset: {
          type: Number,
          value: 0,
          reflectToAttribute: true
        }
      };
    }
    static get observers() {
      return [`_positionSettingsChanged(positionTarget, horizontalAlign, verticalAlign,
        horizontalOverlap, verticalOverlap, horizontalOffset, verticalOffset)`];
    }

    _positionSettingsChanged() {
      this.updatePosition();
    }

    updatePosition() {
      if (!this.positionTarget) {
        return;
      }
      const targetRect = this.positionTarget.getBoundingClientRect();
      const ltr = getComputedStyle(this).direction === 'ltr';
      const leftAlign = (ltr && this.horizontalAlign === 'start')
        || (!ltr && this.horizontalAlign === 'end');
      const horAlignProp = leftAlign ? 'left' : 'right';

      let x = this.horizontalOffset || 0;
      if (horAlignProp === 'left') {
        this.style.removeProperty('right');
        x += targetRect.left;
      } else {
        this.style.removeProperty('left');
        const viewportWidth = Math.min(window.innerWidth, document.documentElement.clientWidth);
        x += viewportWidth - targetRect.right;
      }
      if (!this.horizontalOverlap) {
        x += targetRect.width;
      }
      this.style[horAlignProp] = x + 'px';

      let y = this.verticalOffset || 0;
      if (this.verticalAlign === 'top'){
        this.style.removeProperty('bottom');
        y += targetRect.top;
      } else {
        this.style.removeProperty('top');
        const viewportHeight = Math.min(window.innerHeight, document.documentElement.clientHeight);
        y += viewportHeight - targetRect.bottom
      }
      if (!this.verticalOverlap) {
        y += targetRect.height;
      }
      this.style[this.verticalAlign] = y + 'px';
    }
  };
</script>
